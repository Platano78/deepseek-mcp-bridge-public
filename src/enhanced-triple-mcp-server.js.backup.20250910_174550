// src/enhanced-triple-mcp-server.js
// GREEN PHASE: Enhanced MCP Server with triple endpoint support

import { Server } from '@modelcontextprotocol/sdk/server/index.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import {
  CallToolRequestSchema,
  ErrorCode,
  ListToolsRequestSchema,
  McpError,
} from '@modelcontextprotocol/sdk/types.js';
import { TripleDeepSeekBridge } from './triple-bridge.js';

export class EnhancedTripleMCPServer {
  constructor() {
    this.server = new Server({
      name: 'deepseek-mcp-bridge',
      version: '7.0.0'
    }, {
      capabilities: {
        tools: {}
      }
    });
    
    this.bridge = new TripleDeepSeekBridge();
    this.setupTools();
  }

  async getToolList() {
    const response = await this.server.request(ListToolsRequestSchema, {});
    return response.tools;
  }

  setupTools() {
    // Enhanced query_deepseek tool with triple endpoint support
    this.server.setRequestHandler(CallToolRequestSchema, async (request) => {
      const { name, arguments: args } = request.params;
      
      if (name === 'query_deepseek') {
        return await this.handleEnhancedQuery(args);
      }
      
      if (name === 'check_deepseek_status') {
        return await this.handleTripleStatus();
      }

      if (name === 'route_to_endpoint') {
        return await this.handleDirectRouting(args);
      }

      if (name === 'compare_endpoints') {
        return await this.handleEndpointComparison(args);
      }
      
      throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`);
    });

    this.server.setRequestHandler(ListToolsRequestSchema, async () => {
      return {
        tools: [
          {
            name: 'query_deepseek',
            description: 'Smart AI query with automatic endpoint routing based on task specialization. Routes coding tasks to Qwen 3 Coder 480B, math/analysis to DeepSeek V3, unlimited tokens to local DeepSeek.',
            inputSchema: {
              type: 'object',
              properties: {
                prompt: { 
                  type: 'string', 
                  description: 'Your question or task' 
                },
                context: {
                  type: 'string',
                  description: 'Additional context for the query'
                },
                task_type: { 
                  type: 'string', 
                  enum: ['coding', 'debugging', 'refactoring', 'game_dev', 'analysis', 'architecture', 'math', 'unlimited', 'general'],
                  description: 'Task type for optimal endpoint selection' 
                },
                endpoint_preference: {
                  type: 'string',
                  enum: ['local', 'nvidia_deepseek', 'nvidia_qwen', 'auto'],
                  description: 'Force specific endpoint (auto = smart routing)'
                },
                temperature: { 
                  type: 'number', 
                  description: 'Response creativity (0.1-1.0)' 
                }
              },
              required: ['prompt']
            }
          },
          {
            name: 'check_deepseek_status',
            description: 'Check status of all three AI endpoints: Local DeepSeek, NVIDIA DeepSeek V3, and NVIDIA Qwen 3 Coder 480B',
            inputSchema: { 
              type: 'object', 
              properties: {} 
            }
          },
          {
            name: 'route_to_endpoint',
            description: 'Directly query a specific endpoint with full control',
            inputSchema: {
              type: 'object',
              properties: {
                endpoint: { 
                  type: 'string', 
                  enum: ['local', 'nvidia_deepseek', 'nvidia_qwen'],
                  description: 'Specific endpoint to use' 
                },
                prompt: { 
                  type: 'string', 
                  description: 'Query for the endpoint' 
                }
              },
              required: ['endpoint', 'prompt']
            }
          },
          {
            name: 'compare_endpoints',
            description: 'Run the same prompt on multiple endpoints for comparison',
            inputSchema: {
              type: 'object',
              properties: {
                prompt: { 
                  type: 'string', 
                  description: 'Prompt to test on all endpoints' 
                },
                endpoints: {
                  type: 'array',
                  items: { 
                    type: 'string', 
                    enum: ['local', 'nvidia_deepseek', 'nvidia_qwen'] 
                  },
                  description: 'Endpoints to compare (default: all)'
                }
              },
              required: ['prompt']
            }
          }
        ]
      };
    });
  }

  async handleEnhancedQuery(args) {
    const { 
      prompt, 
      context, 
      task_type, 
      endpoint_preference,
      temperature 
    } = args;
    
    try {
      const fullPrompt = context ? `${context}\n\n${prompt}` : prompt;
      
      const response = await this.bridge.handleEnhancedQuery({
        prompt: fullPrompt,
        task_type,
        endpoint_preference,
        temperature
      });
      
      return response;
    } catch (error) {
      return {
        content: [{
          type: 'text',
          text: `Error: ${error.message}`
        }],
        isError: true
      };
    }
  }

  async handleTripleStatus() {
    return await this.bridge.handleTripleStatus();
  }

  async handleDirectRouting(args) {
    return await this.bridge.handleDirectRouting(args);
  }

  async handleEndpointComparison(args) {
    return await this.bridge.handleEndpointComparison(args);
  }

  async start() {
    const transport = new StdioServerTransport();
    await this.server.connect(transport);
    // Enhanced Triple Endpoint DeepSeek MCP Bridge v7.0.0 started
  }
}